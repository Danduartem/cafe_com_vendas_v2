%% GTM Events & Triggers – Café com Vendas
%% Source of truth: repo code (frontend analytics + Netlify functions)

flowchart TB
  %% =========================
  %% Frontend (Client-Side)
  %% =========================
  subgraph CLIENT[Client-Side Tracking]
    direction TB

    subgraph INIT[App Initialization]
      A1[page_view]
      A2[app_initialized]
      A3[components_initialized]
    end

    subgraph CONTENT[Content Interactions]
      C1[banner_cta_click]
      C2[urgency_message_click]
      C3[final_cta_click]
      C4[solution_pillar_click]
      C5[solution_cta_click]
      C6[vision_outcome_click]
      C7[vision_outcome_focus]
      C8[vision_outcome_engagement]
      C9[vision_cta_click]
      C10[credential_click]
      C11[presenter_photo_click]
      C12[authority_element_click]
      C13[view_mbway_option]
      C14[whatsapp_click]
    end

    subgraph ENG[Engagement Tracking]
      E1[section_view]
      E2[view_testimonials_section]
      E3[scroll_depth 10/25/50/75/90]
      E4["faq_toggle (open/close)"]
      E5[faq_meaningful_engagement]
      E6[section_engagement]
    end

    subgraph CHECKOUT[Checkout & Conversions]
      K1[checkout_opened]
      K2[cta_click]:::alias
      K3[form_submission]
      K4[lead_form_submitted]
      K5[purchase_completed]
      K6[purchase_blocked_duplicate]
      K7[payment_flow: multibanco_voucher_displayed]
      K8[payment_flow: purchase_completed]
      K9[payment_flow: payment_failed]
      K10[conversion_funnel: payment_initiated]
      K11[conversion_funnel: payment_failed]
    end

    subgraph ERR[Errors]
      R1[error]
      R2[checkout: payment_error]:::alias
    end

    %% Frontend pipeline
    F0["analytics.track(...)<br/>AnalyticsHelpers.*"] --> F1["GTM Plugin<br/>pushToDataLayerWithEventId"]
    F1 --> F2[window.dataLayer]
    F2 --> F3["GTM Client Container"]

    %% Events feeding the pipeline
    A1 --> F0
    A2 --> F0
    A3 --> F0

    C1 --> F0
    C2 --> F0
    C3 --> F0
    C4 --> F0
    C5 --> F0
    C6 --> F0
    C7 --> F0
    C8 --> F0
    C9 --> F0
    C10 --> F0
    C11 --> F0
    C12 --> F0
    C13 --> F0
    C14 --> F0

    E1 --> F0
    E2 --> F0
    E3 --> F0
    E4 --> F0
    E5 --> F0
    E6 --> F0

    K1 --> F0
    K2 --> F0
    K3 --> F0
    K4 --> F0
    K5 --> F0
    K6 --> F0
    K7 --> F0
    K8 --> F0
    K9 --> F0
    K10 --> F0
    K11 --> F0

    R1 --> F0
    R2 --> F0

    %% Notes about normalization and enrichment
    classDef note fill:#f6f8fa,stroke:#c9d1d9,color:#24292f;
    N1([GTM normalizer adds: event_id, timestamp, debug_info;<br/>string sanitization for GA4]):::note
    F1 -.-> N1
  end

  %% =========================
  %% GTM/GA4
  %% =========================
  F3 --> T1[GA4 Tags / Other Tags]

  %% =========================
  %% Server-Side Path
  %% =========================
  subgraph SERVER[Server-Side Attribution]
    direction TB
    S1["Stripe Webhook<br/>payment_intent.succeeded"] --> S2["Netlify Function: stripe-webhook"]
    S2 --> S3[sendPurchaseToGA4]

    S3 --> S4["Server GTM Container<br/>(SGTM / mp/collect)"]
    S4 --> S5[GA4 Purchase]
  end

  %% =========================
  %% Legend / Sources
  %% =========================
  subgraph LEGEND[Legend]
    L1["Alias events (test/dev) share same trigger path"]:::alias
    L2[Examples of sources]
    L2a[page_view: src/assets/js/app.ts]
    L2b[section_view: section-tracking plugin]
    L2c[scroll_depth: scroll-tracking plugin]
    L2d[faq_*: components/ui/accordion]
    L2e[checkout_*: src/_includes/sections/checkout]
    L2f[payment_flow & conversion_funnel: thank-you section]
    L2g[whatsapp_click: global click handler]
  end

  classDef alias fill:#fff7ed,stroke:#f97316,color:#7c2d12;

%% =========================
%% Event Index (from code)
%% =========================
%% Initialization: page_view, app_initialized, components_initialized
%% Content: banner_cta_click, urgency_message_click, final_cta_click,
%%   solution_pillar_click, solution_cta_click, vision_outcome_click,
%%   vision_outcome_focus, vision_outcome_engagement, vision_cta_click,
%%   credential_click, presenter_photo_click, authority_element_click,
%%   view_mbway_option, whatsapp_click
%% Engagement: section_view, view_testimonials_section, scroll_depth,
%%   faq_toggle, faq_meaningful_engagement, section_engagement
%% Checkout/Conversions: checkout_opened, cta_click, form_submission,
%%   lead_form_submitted, purchase_completed, purchase_blocked_duplicate,
%%   payment_flow:{multibanco_voucher_displayed,purchase_completed,payment_failed},
%%   conversion_funnel:{payment_initiated,payment_failed}
%% Errors: error, (checkout) payment_error
