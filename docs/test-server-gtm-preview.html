<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server GTM Preview Mode Test</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            max-width: 800px; 
            margin: 2rem auto; 
            padding: 0 1rem;
            line-height: 1.6;
        }
        .test-section { 
            border: 1px solid #ddd; 
            margin: 1rem 0; 
            padding: 1rem; 
            border-radius: 8px;
        }
        .success { border-color: #28a745; background-color: #f8fff9; }
        .error { border-color: #dc3545; background-color: #fff8f8; }
        .warning { border-color: #ffc107; background-color: #fffdf0; }
        pre { 
            background: #f5f5f5; 
            padding: 1rem; 
            border-radius: 4px; 
            overflow-x: auto;
            font-size: 0.9rem;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #0056b3; }
        .logs { 
            background: #1a1a1a; 
            color: #f8f8f2; 
            padding: 1rem; 
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üîç Server GTM Preview Mode Test</h1>
    
    <div class="test-section warning">
        <h2>‚ö†Ô∏è Instructions</h2>
        <ol>
            <li><strong>Open Server GTM Preview Mode</strong> in another tab first</li>
            <li><strong>Add debug parameter</strong>: Add <code>?gtm_debug=1756895052790</code> to this page URL</li>
            <li><strong>Run tests</strong> using the buttons below</li>
            <li><strong>Check Server GTM Preview</strong> to see if requests appear</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üß™ Test Controls</h2>
        <button onclick="testProxyEndpoint()">Test Proxy Endpoint</button>
        <button onclick="testDirectGTM()">Test Direct GTM (Should Fail in Preview)</button>
        <button onclick="testGtagEvent()">Test Gtag Event</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="test-section">
        <h2>üìä Test Status</h2>
        <div id="test-status">
            <p><span class="status-indicator status-info"></span>Ready to test</p>
        </div>
    </div>

    <div class="test-section">
        <h2>üîç Environment Detection</h2>
        <div id="environment-info">
            <p><strong>Preview Mode Detected:</strong> <span id="preview-mode">Checking...</span></p>
            <p><strong>Current URL:</strong> <span id="current-url"></span></p>
            <p><strong>Has Debug Param:</strong> <span id="debug-param">No</span></p>
            <p><strong>Proxy Endpoint:</strong> <code id="proxy-endpoint"></code></p>
            <p><strong>Server GTM Direct:</strong> <code id="server-gtm"></code></p>
        </div>
    </div>

    <div class="test-section">
        <h2>üìù Test Logs</h2>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        // Configuration
        const PROXY_ENDPOINT = '/.netlify/functions/gtm-proxy';
        const SERVER_GTM_ENDPOINT = 'https://server-side-tagging-m5scdmswwq-uc.a.run.app';
        const GA4_MEASUREMENT_ID = 'G-T06WRKJGRW';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateEnvironmentInfo();
            log('üöÄ Server GTM Preview Test initialized');
        });

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const emoji = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            logs.innerHTML += `[${timestamp}] ${emoji[type]} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[GTM Test] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            const indicator = `<span class="status-indicator status-${type}"></span>`;
            statusDiv.innerHTML = `<p>${indicator}${message}</p>`;
        }

        // Environment detection
        function updateEnvironmentInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasDebug = urlParams.has('gtm_debug') || urlParams.has('gtm_preview');
            
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('debug-param').textContent = hasDebug ? 'Yes' : 'No';
            document.getElementById('proxy-endpoint').textContent = window.location.origin + PROXY_ENDPOINT;
            document.getElementById('server-gtm').textContent = SERVER_GTM_ENDPOINT;
            
            // Check preview mode
            const previewMode = isPreviewModeActive();
            document.getElementById('preview-mode').textContent = previewMode ? 'Yes' : 'No';
            
            if (previewMode) {
                log('‚úÖ Preview mode detected', 'success');
            } else {
                log('‚ö†Ô∏è Preview mode not detected - add ?gtm_debug=1756895052790 to URL', 'warning');
            }
        }

        // Preview mode detection (same as in the actual implementation)
        function isPreviewModeActive() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('gtm_debug') || urlParams.has('gtm_preview')) {
                return true;
            }
            
            const cookies = document.cookie;
            if (cookies.includes('gtm_auth') || 
                cookies.includes('gtm_preview') || 
                cookies.includes('gtm_debug')) {
                return true;
            }
            
            if (window.google_tag_manager && window.google_tag_manager.dataLayer) {
                return true;
            }
            
            if (document.referrer && document.referrer.includes('tagassistant.google.com')) {
                return true;
            }
            
            return false;
        }

        // Test proxy endpoint
        async function testProxyEndpoint() {
            updateStatus('Testing proxy endpoint...', 'info');
            log('üß™ Testing proxy endpoint');
            
            const testUrl = `${PROXY_ENDPOINT}/g/collect?v=2&tid=${GA4_MEASUREMENT_ID}&cid=test-client-id&t=event&ec=test&ea=proxy-test&el=preview-test&gtm_debug=${Date.now()}`;
            
            try {
                const response = await fetch(testUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'X-Gtm-Server-Preview': 'test-preview-token'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Proxy endpoint responded successfully', 'success');
                    updateStatus('Proxy test successful', 'success');
                } else {
                    log(`‚ùå Proxy endpoint error: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('Proxy test failed', 'error');
                }
            } catch (error) {
                log(`‚ùå Proxy endpoint test failed: ${error.message}`, 'error');
                updateStatus('Proxy test failed', 'error');
            }
        }

        // Test direct GTM (should fail in preview)
        async function testDirectGTM() {
            updateStatus('Testing direct GTM...', 'info');
            log('üß™ Testing direct Server GTM endpoint');
            
            const testUrl = `${SERVER_GTM_ENDPOINT}/g/collect?v=2&tid=${GA4_MEASUREMENT_ID}&cid=test-client-id&t=event&ec=test&ea=direct-test&el=preview-test&gtm_debug=${Date.now()}`;
            
            try {
                const response = await fetch(testUrl, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    log('‚úÖ Direct GTM responded, but likely won\'t appear in preview due to CORS', 'warning');
                    updateStatus('Direct GTM responded (preview may not work)', 'warning');
                } else {
                    log(`‚ùå Direct GTM error: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('Direct GTM test failed', 'error');
                }
            } catch (error) {
                log(`‚ùå Direct GTM test failed (expected in CORS environment): ${error.message}`, 'warning');
                updateStatus('Direct GTM blocked by CORS (expected)', 'warning');
            }
        }

        // Test gtag event (if gtag is loaded)
        function testGtagEvent() {
            updateStatus('Testing gtag event...', 'info');
            log('üß™ Testing gtag event tracking');
            
            if (typeof gtag === 'function') {
                gtag('event', 'test_event', {
                    event_category: 'test',
                    event_label: 'preview-test',
                    custom_parameter_1: 'test-value',
                    debug_mode: true
                });
                log('‚úÖ Gtag event sent', 'success');
                updateStatus('Gtag event sent', 'success');
            } else {
                log('‚ö†Ô∏è Gtag not loaded - load GTM first', 'warning');
                updateStatus('Gtag not available', 'warning');
            }
        }
    </script>
</body>
</html>