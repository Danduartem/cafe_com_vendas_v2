<style>
#checkoutModal {
  border: none;
  padding: 0;
  position: fixed;
  margin: auto;
  inset: 0;
  max-inline-size: min(90vw, 32rem);
  /* Safari fix: explicit height with fit-content */
  height: fit-content;
  /* Responsive height with Safari fallback */
  max-height: calc(100dvh - 2rem);
  max-height: calc(var(--vh, 1vh) * 100 - 2rem);
  border-radius: 0.75rem;
  background: white;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  animation: modalFadeIn 300ms ease-out;
  will-change: transform;
  /* Enable vertical scrolling, prevent horizontal */
  overflow-y: auto;
  overflow-x: hidden;
}

/* Mobile-specific adjustments */
@media (max-width: 640px) {
  #checkoutModal {
    max-inline-size: calc(100vw - 2rem);
    /* Mobile sizing with safe area support */
    max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 2rem);
    max-height: calc(var(--vh, 1vh) * 100 - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 2rem);
    padding-top: max(1.5rem, env(safe-area-inset-top));
    padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
  }
}

#checkoutModal::backdrop {
  background-color: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(2px);
  animation: backdropFadeIn 200ms ease-out;
  -webkit-backdrop-filter: blur(2px);
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes backdropFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#checkoutModal > article {
  display: flex;
  flex-direction: column;
  min-height: 100%;
  overscroll-behavior-y: contain;
  -webkit-overflow-scrolling: touch;
}

#checkoutModal header {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: space-between;
  align-items: flex-start;
  padding: 1.5rem;
  border-bottom: 1px solid rgb(209 213 219);
  position: sticky;
  top: 0;
  background: white;
  z-index: 10;
}

@media (max-width: 640px) {
  #checkoutModal header {
    padding: 1.25rem 1rem;
  }
}

#checkoutModal main {
  padding: 1.5rem;
  flex-grow: 1;
  padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
}

@media (max-width: 640px) {
  #checkoutModal main {
    padding: 1.25rem 1rem;
    padding-bottom: calc(1.25rem + env(safe-area-inset-bottom));
  }
}

#checkoutModal .error-message {
  color: var(--color-burgundy-700, #81171F);
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

#checkoutModal input.error {
  border-color: var(--color-burgundy-700, #81171F);
  outline-color: var(--color-burgundy-700, #81171F);
}

/* Responsive typography and enhanced mobile experience */
@media (max-width: 640px) {
  #checkoutModal h3 {
    font-size: 1.125rem;
    line-height: 1.25;
  }
  
  #checkoutModal label {
    font-size: 0.9375rem;
  }
  
  #checkoutModal input,
  #checkoutModal select {
    font-size: 16px; /* Prevents zoom on iOS */
    min-height: 2.75rem;
  }
  
  #checkoutModal button[type="submit"] {
    font-size: 1rem;
  }
  
  /* Better focus states for mobile */
  #checkoutModal input:focus,
  #checkoutModal select:focus {
    box-shadow: 0 0 0 3px rgba(129, 23, 31, 0.1);
  }
}

/* Improve keyboard visibility on mobile */
@supports (height: 100dvh) {
  #checkoutModal:has(input:focus, select:focus) {
    max-height: calc(100dvh - 8rem);
  }
}
</style>

<dialog id="checkoutModal" aria-labelledby="modalTitle">
  <article>
    <header>
        <div>
          <p class="text-xs tracking-widest uppercase font-medium text-neutral-600">
            InscriÃ§Ã£o
          </p>
          <h3 id="modalTitle" 
              class="font-lora text-xl lg:text-2xl leading-tight font-medium text-navy-800">
            {{ site.event.name }}
          </h3>
        </div>
        <button id="closeCheckout" 
                type="button"
                data-modal-close
                aria-label="Fechar modal"
                class="flex min-h-[2.75rem] min-w-[2.75rem] h-11 w-11 items-center justify-center rounded-full transition-colors duration-200 hover:bg-gray-100 -mr-2 -mt-2">
          <svg class="h-5 w-5 text-neutral-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
    </header>

    <div class="h-1 sm:h-1.5 w-full bg-neutral-200">
      <div id="progressBar" 
           class="h-full w-1/2 rounded-r-full transition-all duration-500 ease-out bg-gradient-to-r from-burgundy-700 to-burgundy-600 shadow-sm">
      </div>
    </div>

    <main>
        <!-- Step 1: Lead Form -->
        <form id="leadForm" class="space-y-5 sm:space-y-6" novalidate>
          <div>
            <label for="fullName" 
                   class="block text-sm font-medium mb-2 text-navy-700">
              Nome completo *
            </label>
            <input id="fullName" 
                   name="fullName" 
                   type="text"
                   required 
                   autocomplete="name"
                   placeholder="Digite seu nome completo"
                   class="w-full rounded-xl border border-neutral-300 px-4 py-3 sm:py-3 text-base sm:text-base transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-50 text-navy-800 focus:border-burgundy-700 focus:ring-burgundy-700 touch-manipulation"/>
          </div>
          
          <div>
            <label for="email" 
                   class="block text-sm font-medium mb-2 text-navy-700">
              Email *
            </label>
            <input id="email" 
                   name="email" 
                   type="email" 
                   required 
                   autocomplete="email"
                   placeholder="seu@email.com"
                   class="w-full rounded-xl border border-neutral-300 px-4 py-3 sm:py-3 text-base sm:text-base transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-50 text-navy-800 focus:border-burgundy-700 focus:ring-burgundy-700 touch-manipulation"/>
          </div>
          
          <div>
            <label for="phone" 
                   class="block text-sm font-medium mb-2 text-navy-700">
              Telefone/WhatsApp *
            </label>
            <div class="relative flex">
              <select id="countryCode" 
                      name="countryCode"
                      class="rounded-l-xl rounded-r-none border border-neutral-300 border-r-0 pl-3 pr-8 py-3 text-sm font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-50 text-navy-800 focus:border-burgundy-700 focus:ring-burgundy-700 bg-white focus:z-10 touch-manipulation min-w-[120px]">
                <option value="+351" selected>ðŸ‡µðŸ‡¹ +351</option>
                <option value="+55">ðŸ‡§ðŸ‡· +55</option>
                <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                <option value="+39">ðŸ‡®ðŸ‡¹ +39</option>
              </select>
              <input id="phone" 
                     name="phone" 
                     type="tel" 
                     required 
                     inputmode="tel" 
                     pattern="[0-9\s\-\(\)]{7,15}"
                     title="Apenas nÃºmeros, espaÃ§os, traÃ§os e parÃªnteses (7-15 dÃ­gitos)"
                     placeholder="912 345 678"
                     class="flex-1 rounded-l-none rounded-r-xl border border-neutral-300 px-4 py-3 text-base transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-50 text-navy-800 focus:border-burgundy-700 focus:ring-burgundy-700 focus:z-10 touch-manipulation"/>
            </div>
          </div>

          <button id="leadSubmit" 
                  type="submit" 
                  class="w-full rounded-xl px-6 py-4 sm:py-4 text-white font-semibold text-lg shadow-lg transform transition-all duration-300 hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-opacity-50 bg-gradient-to-r from-burgundy-700 to-burgundy-600 focus:ring-burgundy-700 touch-manipulation min-h-[3.5rem] mt-8">
            <div class="inline-flex items-center justify-center gap-2 min-h-[1.5rem]">
              <span id="leadSubmitText" class="transition-opacity duration-200">Garantir minha vaga</span>
              <svg id="leadSubmitSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </button>

          <div id="leadError" 
               class="hidden mt-2 p-3 rounded-xl text-sm bg-burgundy-50 text-burgundy-700 border border-burgundy-200">
          </div>
        </form>

        <!-- Step 2: Payment -->
        <div id="paymentStep" class="hidden space-y-4">
          <div class="flex items-center justify-between mb-4 p-3 rounded-xl bg-neutral-50">
            <div class="flex items-center gap-2">
              <svg class="h-4 w-4 text-neutral-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              <span class="text-sm font-medium text-neutral-700">
                Pagamento 100% seguro
              </span>
            </div>
            <span class="text-xs text-neutral-500 font-medium">Powered by Stripe</span>
          </div>

          <div class="mb-4 p-4 rounded-xl bg-green-50 border border-green-200">
            <h4 class="font-medium text-base mb-2 text-navy-800">
              {{ site.event.pricing.tiers[0].label }}
            </h4>
            <div class="flex justify-between items-center">
              <span class="text-sm text-neutral-600">
                {{ site.event.date.local }} â€¢ {{ site.event.location.city }}
              </span>
              <span class="font-semibold text-lg text-navy-800">
                â‚¬{{ site.event.pricing.tiers[0].price }}
              </span>
            </div>
            <p class="text-xs mt-1 text-green-700">
              {{ site.event.pricing.tiers[0].notes }}
            </p>
          </div>

          <div class="mb-4 relative">
            <!-- ðŸš€ Predictive Payment Status Indicator -->
            <div id="predictive-status" class="hidden mb-3 p-2 rounded-lg bg-blue-50 border border-blue-200">
              <div class="flex items-center gap-2 text-sm text-blue-700">
                <div class="w-3 h-3 bg-blue-400 rounded-full animate-pulse"></div>
                <span>Preparando pagamento em segundo plano...</span>
              </div>
            </div>

            <div id="payment-skeleton" class="space-y-4">
              <div class="animate-pulse">
                <div class="h-4 bg-neutral-200 rounded w-1/3 mb-2"></div>
                <div class="h-10 bg-neutral-100 rounded-lg border border-neutral-200"></div>
              </div>
              <div class="animate-pulse">
                <div class="h-4 bg-neutral-200 rounded w-1/4 mb-2"></div>
                <div class="h-10 bg-neutral-100 rounded-lg border border-neutral-200"></div>
              </div>
              <div class="animate-pulse">
                <div class="h-4 bg-neutral-200 rounded w-2/5 mb-2"></div>
                <div class="h-10 bg-neutral-100 rounded-lg border border-neutral-200"></div>
              </div>
              <div class="animate-pulse">
                <div class="h-4 bg-neutral-200 rounded w-1/3 mb-2"></div>
                <div class="flex gap-2">
                  <div class="h-10 bg-neutral-100 rounded-lg border border-neutral-200 flex-1"></div>
                  <div class="h-10 bg-neutral-100 rounded-lg border border-neutral-200 w-20"></div>
                </div>
              </div>
            </div>

            <div id="payment-element" class="hidden">
              <!-- Stripe Elements will mount here -->
            </div>
          </div>

          <button id="payBtn" 
                  type="button"
                  disabled
                  class="w-full rounded-2xl px-6 py-3 text-white font-semibold shadow-lg transform transition-all duration-200 hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none bg-navy-800 focus:ring-navy-700 mt-6">
            <div class="inline-flex items-center justify-center gap-2 min-h-[1.5rem]">
              <span id="payBtnText">Confirmar pagamento â€¢ â‚¬{{ site.event.pricing.tiers[0].price }}</span>
              <svg id="payBtnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          </button>

          <div id="payError" 
               class="hidden mt-2 p-3 rounded-xl text-sm bg-burgundy-50 text-burgundy-700 border border-burgundy-200">
          </div>
        </div>

        <!-- Step Success: Payment Confirmed -->
        <div id="paymentSuccess" class="hidden text-center space-y-4">
          <div class="p-6 rounded-2xl bg-peach-50 border-2 border-peach-300">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-peach-200">
              <svg class="w-8 h-8 text-burgundy-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h4 class="text-xl font-semibold mb-2 text-navy-800">
              Pagamento confirmado! ðŸŽ‰
            </h4>
            <p class="text-base mb-4 text-neutral-700">
              Sua vaga estÃ¡ garantida. Redirecionando para os detalhes...
            </p>
            <div class="animate-pulse">
              <div class="h-2 rounded-full mx-auto w-24 bg-burgundy-300"></div>
            </div>
          </div>
        </div>

        <div class="mt-6 pt-4 border-t border-neutral-200 text-center">
          <p class="text-xs text-neutral-500">
            Ao continuar, vocÃª concorda com nossos 
            <a href="/termos-condicoes/" class="underline hover:no-underline">termos de serviÃ§o</a>.
            <br>
            {{ site.event.guarantee.policy }}
          </p>
        </div>

    </main>
  </article>
</dialog>